local ADDON, Addon = ...
local Data = Addon:NewModule('Data')

local KNOWLEDGE_CURRENCY_ID = 1171
local fakeTooltip
local cachedItems = {}

local worldQuestReps = {[49413]={2159,2103},[50845]={2159,2103},[50846]={2159,2103},[50847]={2159,2103},[50850]={2159,2103},[50853]={2159,2103},[50854]={2159,2103},[50857]={2159,2103},[50859]={2159,2103},[50861]={2159,2103},[50862]={2159,2103},[50863]={2159,2103},[50866]={2159,2103},[50867]={2159,2103},[50868]={2159,2103},[50869]={2159,2103},[50870]={2159,2103},[50873]={2159,2103},[50874]={2159,2103},[50875]={2159,2103},[50876]={2159,2103},[50877]={2159,2103},[50885]={2159,2103},[51081]={2159,2103},[51084]={2159,2103},[51175]={2164,2159,2103},[51179]={2164,2159,2103},[51444]={2164,2159,2103},[51450]={2164,2159,2103},[51630]={2163,2159,2103},[51642]={2163,2159,2103},[52350]=2163,[52858]={2164,2159,2103},[52877]={2164,2159,2103},[52892]={2159,2103},[52923]={2159,2103},[52937]={2159,2103},[52938]={2159,2103},[50527]={2159,2103},[50651]={2159,2103},[50737]={2159,2103},[50756]={2159,2103},[50782]={2159,2103},[50855]={2159,2103},[50858]={2159,2103},[50969]={2159,2103},[51178]={2159,2103},[51373]={2159,2103},[51374]={2159,2103},[51814]={2159,2103},[51815]={2159,2103},[51816]={2159,2103},[51821]={2159,2103},[51822]={2159,2103},[51824]={2159,2103},[52249]={2159,2103},[52250]={2159,2103},[53165]={2159,2103},[49068]={2159,2103},[49444]={2159,2103},[50287]={2159,2103},[50524]={2159,2103},[50540]={2159,2103},[50547]={2159,2103},[50548]={2159,2103},[50571]={2159,2103},[50574]={2159,2103},[50578]={2159,2103},[50581]={2159,2103},[50592]={2159,2103},[50619]={2159,2103},[50636]={2159,2103},[50652]={2159,2103},[50744]={2159,2103},[50765]={2159,2103},[50964]={2159,2103},[50966]={2159,2103},[50999]={2159,2103},[51000]={2159,2103},[51010]={2159,2103},[51013]={2159,2103},[51036]=2157,[51037]=2157,[51038]=2157,[51039]=2157,[51040]=2157,[51041]=2157,[51042]=2157,[51043]=2157,[51044]=2157,[51045]=2157,[51046]=2157,[51047]=2157,[51048]=2157,[51049]=2157,[51050]=2157,[51051]=2157,[51232]={2159,2103},[51475]={2159,2103},[51494]={2159,2103},[51495]={2159,2103},[51496]={2159,2103},[51497]={2159,2103},[52248]={2159,2103},[52335]=2157,[52336]={2159,2103},[52341]=2157,[52342]=2157,[52358]={2159,2103},[52359]={2159,2103},[52369]=2157,[52373]={2159,2103},[52374]=2157,[52382]=2157,[52384]=2157,[52387]=2157,[52388]=2157,[52395]={2159,2103},[52398]=2157,[52409]={2159,2103},[52420]={2159,2103},[52421]={2159,2103},[52425]={2159,2103},[52348]=2163,[52349]=2163,[52351]=2163,[50747]={2159,2103},[50871]={2159,2103},[50872]={2159,2103},[51014]={2159,2103},[52251]={2159,2103},[52383]={2159,2103},[52408]={2159,2103},[50459]={2159,2156},[50461]={2159,2156},[50468]={2159,2156},[50483]={2159,2156},[50488]={2159,2156},[50489]={2159,2156},[50490]={2159,2156},[50492]={2159,2156},[50496]={2159,2156},[50498]={2159,2156},[50499]={2159,2156},[50501]={2159,2156},[50503]={2159,2156},[50505]={2159,2156},[50507]={2159,2156},[50509]={2159,2156},[50510]={2159,2156},[50512]={2159,2156},[50513]={2159,2156},[50514]={2159,2156},[50515]={2159,2156},[50517]={2159,2156},[50518]={2159,2156},[50519]={2159,2156},[50564]={2159,2156},[50566]={2159,2156},[50568]={2159,2156},[51064]={2164,2159,2156},[51411]={2164,2159,2156},[51412]={2164,2159,2156},[51415]={2164,2159,2156},[51628]={2163,2159,2156},[51640]={2163,2159,2156},[52181]={2159,2156},[52754]={2159,2156},[52779]={2159,2156},[52799]={2159,2156},[52803]={2159,2156},[52832]={2164,2159,2156},[52884]={2164,2159,2156},[50899]={2159,2156},[50936]={2159,2156},[50961]={2159,2156},[50962]={2159,2156},[51109]={2159,2156},[51127]={2159,2156},[51131]={2159,2156},[51154]={2159,2156},[51166]={2159,2156},[51172]={2159,2156},[51546]={2159,2156},[51548]={2159,2156},[51550]={2159,2156},[52785]={2159,2156},[50443]={2159,2156},[50474]={2159,2156},[50497]={2159,2156},[50521]={2159,2156},[50529]={2159,2156},[50545]={2159,2156},[50549]={2159,2156},[50559]={2159,2156},[50572]={2159,2156},[50577]={2159,2156},[50587]={2159,2156},[50634]={2159,2156},[50648]={2159,2156},[50650]={2159,2156},[50660]={2159,2156},[50676]={2159,2156},[50689]={2159,2156},[50695]={2159,2156},[50717]={2159,2156},[50718]={2159,2156},[50735]={2159,2156},[50786]={2159,2156},[50813]={2159,2156},[51005]={2159,2156},[51006]={2159,2156},[51009]={2159,2156},[52006]={2159,2156},[52007]={2159,2156},[52337]={2159,2156},[52361]={2159,2156},[52372]={2159,2156},[52385]={2159,2156},[52396]={2159,2156},[52410]={2159,2156},[52418]={2159,2156},[52426]={2159,2156},[50487]=2156,[50502]={2159,2156},[50506]=2156,[50511]={2159,2156},[50516]={2159,2156},[50570]={2159,2156},[50665]={2159,2156},[50667]={2159,2156},[51176]={2159,2156},[52360]={2159,2156},[52808]={2164,2159,2156},[51012]={2159,2156},[50975]={2164,2159,2158},[51095]={2159,2158},[51096]={2159,2158},[51097]={2159,2158},[51098]={2159,2158},[51100]={2159,2158},[51102]={2159,2158},[51103]={2159,2158},[51104]={2159,2158},[51106]={2159,2158},[51108]={2159,2158},[51112]={2159,2158},[51113]={2159,2158},[51114]={2159,2158},[51115]={2159,2158},[51116]={2159,2158},[51117]={2159,2158},[51119]={2159,2158},[51120]={2159,2158},[51121]={2159,2158},[51122]={2159,2158},[51123]={2159,2158},[51153]={2159,2158},[51155]={2159,2158},[51156]={2159,2158},[51157]={2159,2158},[51185]={2164,2159,2158},[51422]={2164,2159,2158},[51428]={2164,2159,2158},[51429]={2159,2158},[51629]={2163,2159,2158},[51635]={2163,2159,2158},[51641]={2163,2159,2158},[52196]={2159,2158},[52849]={2164,2159,2158},[52850]={2159,2158},[52856]={2159,2158},[52864]={2159,2158},[52875]={2164,2159,2158},[52878]={2159,2158},[53300]={2159,2158},[51562]={2159,2158},[51564]={2159,2158},[51565]={2159,2158},[51760]={2159,2158},[51783]={2159,2158},[51793]={2159,2158},[51794]={2159,2158},[51804]={2159,2158},[51834]={2159,2158},[51836]={2159,2158},[51853]={2159,2158},[51925]={2159,2158},[51931]={2159,2158},[51933]={2159,2158},[51963]={2159,2158},[51995]={2159,2158},[52059]={2159,2158},[47704]={2159,2158},[49013]={2159,2158},[49345]={2159,2158},[51003]={2159,2158},[51007]={2159,2158},[51008]={2159,2158},[51173]={2159,2158},[51174]={2159,2158},[51181]={2159,2158},[51198]={2159,2158},[51210]={2159,2158},[51223]={2159,2158},[51228]={2159,2158},[51238]={2159,2158},[51239]={2159,2158},[51250]={2159,2158},[51252]={2159,2158},[51285]={2159,2158},[51316]={2159,2158},[51322]={2159,2158},[51330]={2159,2158},[51558]={2159,2158},[51559]={2159,2158},[51763]={2159,2158},[51780]={2159,2158},[51791]={2159,2158},[51792]={2159,2158},[51850]={2159,2158},[51957]={2159,2158},[51983]={2159,2158},[51997]={2159,2158},[52362]={2159,2158},[52397]={2159,2158},[52412]={2159,2158},[52798]={2159,2158},[51099]=2158,[51105]={2159,2158},[51107]={2159,2158},[51124]=2158,[51125]=2158,[51180]={2159,2158},[51561]={2159,2158},[51900]={2159,2158},[51924]={2159,2158},[51928]={2159,2158},[52338]={2159,2158},[52386]={2159,2158},[50992]={2160,2157},[51090]={2160,2157},[51284]={2160,2157},[51317]=2160,[51652]={2160,2157},[51653]={2160,2157},[51660]={2160,2157},[52056]={2160,2157},[52355]={2160,2157},[52404]={2160,2157},[52416]={2160,2157},[51461]={2161,2157},[51616]=2161,[51742]={2161,2157},[51919]={2161,2157},[52381]={2161,2157},[52406]={2161,2157},[53282]={2160,2157},[53311]={2161,2157},[53321]={2159,2156},[52364]={2161,2157},[53314]={2160,2157},[50981]={2162,2157},[51977]={2162,2157},[51978]={2162,2157},[51982]={2162,2157},[52063]={2162,2157},[52133]={2162,2157},[52198]={2162,2157},[52199]=2162,[52315]={2162,2157},[52332]={2162,2157},[52345]=2163,[52432]=2162,[52446]=2162,[52507]={2162,2157},[52924]={2162,2157},[53025]={2162,2157}}

local invtype_locations = {
	INVTYPE_HEAD = { INVSLOT_HEAD },
	INVTYPE_NECK = { INVSLOT_NECK },
	INVTYPE_SHOULDER = { INVSLOT_SHOULDER },
	INVTYPE_BODY = { INVSLOT_BODY },
	INVTYPE_CHEST = { INVSLOT_CHEST },
	INVTYPE_ROBE = { INVSLOT_CHEST },
	INVTYPE_WAIST = { INVSLOT_WAIST },
	INVTYPE_LEGS = { INVSLOT_LEGS },
	INVTYPE_FEET = { INVSLOT_FEET },
	INVTYPE_WRIST = { INVSLOT_WRIST },
	INVTYPE_HAND = { INVSLOT_HAND },
	INVTYPE_FINGER = { INVSLOT_FINGER1, INVSLOT_FINGER2 },
	INVTYPE_TRINKET = { INVSLOT_TRINKET1, INVSLOT_TRINKET2 },
	INVTYPE_CLOAK = { INVSLOT_BACK },
	INVTYPE_WEAPON = { INVSLOT_MAINHAND, INVSLOT_OFFHAND },
	INVTYPE_SHIELD = { INVSLOT_OFFHAND },
	INVTYPE_2HWEAPON = { INVSLOT_MAINHAND },
	INVTYPE_WEAPONMAINHAND = { INVSLOT_MAINHAND },
	INVTYPE_WEAPONOFFHAND = { INVSLOT_OFFHAND },
	INVTYPE_HOLDABLE = { INVSLOT_OFFHAND },
}

function Data:QuestHasFaction(questID, factionID)
	local reps = worldQuestReps[questID]
	if reps then
		if (type(reps) == "table") then
			for _, fID in ipairs(reps) do
				if fID == factionID then return true end
			end
			return false
		else
			return reps == factionID
		end
	else
		return false
	end
end

function Data:RewardIsUpgrade(itemID, questID)
	local _, _, _, _, _, _, _, _, equipSlot, _, _ = GetItemInfo(itemID)
	local ilvl = self:RewardItemLevel(itemID, questID)

	if equipSlot and invtype_locations[equipSlot] then
		local isUpgrade = false

		for _, slotID in ipairs(invtype_locations[equipSlot]) do
			local currentItem = GetInventoryItemLink("player", slotID)
			if currentItem then
				local currentIlvl = select(4, GetItemInfo(currentItem))
				if not currentIlvl or ilvl >= (currentIlvl - Addon.Config.lootUpgradesLevel) then
					isUpgrade = true
				end
			else
				isUpgrade = true
			end
		end

		return isUpgrade
	else
		return true
	end
end

function Data:RewardItemLevel(itemID, questID)
	local key = itemID..":"..questID
	if cachedItems[key] == nil then
		fakeTooltip:SetOwner(UIParent, "ANCHOR_NONE")
		fakeTooltip:SetQuestLogItem("reward", 1, questID)

		-- local itemLink = select(2, fakeTooltip:GetItem())
		if false and itemLink then
			local itemName, _, _, itemLevel, _, _, _, _, itemEquipLoc, _, _, itemClassID, itemSubClassID = GetItemInfo(itemLink)
			if itemName then
				if (itemClassID == 3 and itemSubClassID == 11) or (itemEquipLoc ~= nil and itemEquipLoc ~= "") then
					cachedItems[key] = itemLevel
				else
					cachedItems[key] = false
				end
			end
		else
			local textLine2 = AWQFakeTooltipTextLeft2 and AWQFakeTooltipTextLeft2:IsShown() and AWQFakeTooltipTextLeft2:GetText()
			local textLine3 = AWQFakeTooltipTextLeft3 and AWQFakeTooltipTextLeft3:IsShown() and AWQFakeTooltipTextLeft3:GetText()
			local textLine4 = AWQFakeTooltipTextLeft4 and AWQFakeTooltipTextLeft4:IsShown() and AWQFakeTooltipTextLeft4:GetText()
			local matcher = string.gsub(ITEM_LEVEL_PLUS, "%%d%+", "(%%d+)+?")
			local itemLevel

			if textLine2 then
				itemLevel = tonumber(textLine2:match(matcher))
			end
			if textLine3 and not itemLevel then
				itemLevel = tonumber(textLine3:match(matcher))
			end
			if textLine4 and not itemLevel then
				itemLevel = tonumber(textLine4:match(matcher))
			end

			cachedItems[key] = itemLevel or false
		end
	end
	return cachedItems[key]
end

function Data:UNIT_QUEST_LOG_CHANGED(arg1)
	if arg1 == "player" then
		wipe(cachedItems)
	end
end
function Data:PLAYER_ENTERING_WORLD()
	wipe(cachedItems)
end

function Data:Startup()
	fakeTooltip = CreateFrame('GameTooltip', 'AWQFakeTooltip', UIParent, 'GameTooltipTemplate')
	fakeTooltip:Hide()

	self:RegisterEvent('UNIT_QUEST_LOG_CHANGED')
	self:RegisterEvent('PLAYER_ENTERING_WORLD')
end
